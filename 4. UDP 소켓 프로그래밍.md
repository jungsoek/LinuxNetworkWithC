# 4. UDP μ†μΌ“ ν”„λ΅κ·Έλλ°

## 4.1 UDP μ„λ²„/ν΄λΌμ΄μ–ΈνΈ κµ¬ν„

### π“ UDPμ νΉμ§• μ”μ•½

| ν•­λ©      | μ„¤λ…                                  |
| --------- | ------------------------------------- |
| μ „μ†΅ λ°©μ‹ | λΉ„μ—°κ²°ν•, λ‹¨λ°©ν–¥ λ©”μ‹μ§€               |
| μ‹ λΆ°μ„±    | μ—†μ (μ†μ‹¤ κ°€λ¥, μμ„ λ’¤λ°”λ€” μ μμ) |
| ν—¤λ” ν¬κΈ° | μ‘μ (8λ°”μ΄νΈ)                        |
| μ†λ„      | λΉ λ¦„, μ§€μ—° μ‹κ°„ μ‘μ                  |
| μ‚¬μ© μ‚¬λ΅€ | DNS, μ¤νΈλ¦¬λ°, VoIP λ“±                |

------

### β… 1. UDP μ„λ²„ κµ¬μ΅°

```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

#define PORT 8888
#define BUF_SIZE 1024

int main() {
    int sock;
    struct sockaddr_in server_addr, client_addr;
    socklen_t client_len = sizeof(client_addr);
    char buffer[BUF_SIZE];

    // 1. μ†μΌ“ μƒμ„±
    sock = socket(AF_INET, SOCK_DGRAM, 0);

    // 2. μ£Όμ† μ„¤μ •
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_addr.s_addr = INADDR_ANY;
    server_addr.sin_port = htons(PORT);

    // 3. λ°”μΈλ”©
    bind(sock, (struct sockaddr*)&server_addr, sizeof(server_addr));

    printf("UDP μ„λ²„ μ‹¤ν–‰ μ¤‘ (ν¬νΈ %d)...\n", PORT);

    // 4. λ°μ΄ν„° μμ‹  λ° μ‘λ‹µ
    while (1) {
        int n = recvfrom(sock, buffer, BUF_SIZE, 0,
                         (struct sockaddr*)&client_addr, &client_len);
        buffer[n] = '\0';

        printf("λ°›μ€ λ©”μ‹μ§€: %s\n", buffer);
        sendto(sock, buffer, strlen(buffer), 0,
               (struct sockaddr*)&client_addr, client_len);
    }

    close(sock);
    return 0;
}
```

------

### β… 2. UDP ν΄λΌμ΄μ–ΈνΈ κµ¬μ΅°

```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

#define SERVER_IP "127.0.0.1"
#define PORT 8888
#define BUF_SIZE 1024

int main() {
    int sock;
    struct sockaddr_in server_addr;
    char buffer[BUF_SIZE];

    // 1. μ†μΌ“ μƒμ„±
    sock = socket(AF_INET, SOCK_DGRAM, 0);

    // 2. μ„λ²„ μ£Όμ† μ„¤μ •
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(PORT);
    inet_pton(AF_INET, SERVER_IP, &server_addr.sin_addr);

    while (1) {
        printf("λ³΄λ‚Ό λ©”μ‹μ§€: ");
        fgets(buffer, BUF_SIZE, stdin);

        // 3. μ„λ²„μ— λ°μ΄ν„° μ „μ†΅
        sendto(sock, buffer, strlen(buffer), 0,
               (struct sockaddr*)&server_addr, sizeof(server_addr));

        // 4. μ„λ²„λ΅λ¶€ν„° μ‘λ‹µ μμ‹ 
        int n = recvfrom(sock, buffer, BUF_SIZE, 0, NULL, NULL);
        buffer[n] = '\0';
        printf("μ„λ²„ μ‘λ‹µ: %s\n", buffer);
    }

    close(sock);
    return 0;
}
```

------

### π“ 3. μ£Όμμ‚¬ν•­ λ° ν

| μ£Όμ          | μ„¤λ…                                    |
| ------------ | --------------------------------------- |
| `recvfrom()` | λ³΄λ‚Έ ν΄λΌμ΄μ–ΈνΈμ μ£Όμ†κ°€ ν•¨κ» μ „λ‹¬λ¨    |
| `sendto()`   | λ§¤λ² λ©μ μ§€ μ£Όμ† λ…μ‹                   |
| λ°μ΄ν„° μ μ‹¤  | μ†μ‹¤ κ°μ§€ λ° μ¬μ „μ†΅μ€ μ§μ ‘ κµ¬ν„ν•΄μ•Ό ν•¨  |
| MTU μ΄κ³Ό     | 1472λ°”μ΄νΈ μ΄μƒμ΄λ©΄ IP μ΅°κ°ν™” λ°μƒ μ£Όμ |

------

### π§ ν…μ¤νΈ

μ„λ²„ μ‹¤ν–‰:

```
gcc -o udp_server udp_server.c
./udp_server
```

ν΄λΌμ΄μ–ΈνΈ μ‹¤ν–‰:

```
gcc -o udp_client udp_client.c
./udp_client
```

------

### β… μ •λ¦¬ μ”μ•½

| ν•­λ©        | TCP                         | UDP                         |
| ----------- | --------------------------- | --------------------------- |
| μ—°κ²° μ—¬λ¶€   | μ—°κ²° μ§€ν–¥ (3-way handshake) | λΉ„μ—°κ²°ν•                    |
| API         | `listen`, `accept` λ“±       | μ—†μ (`sendto`, `recvfrom`) |
| λ°μ΄ν„° νλ¦„ | μ¤νΈλ¦Ό                      | λ©”μ‹μ§€ λ‹¨μ„                 |
| μ‚¬μ© μ     | HTTP, SSH                   | DNS, VoIP                   |

## 4.2 `recvfrom`, `sendto` ν•¨μ μ΄ν•΄

### π“ `sendto()` ν•¨μ

#### π“ μ •μ

```
ssize_t sendto(int sockfd, const void *buf, size_t len, int flags,
               const struct sockaddr *dest_addr, socklen_t addrlen);
```

| μΈμ        | μ„¤λ…                                              |
| ----------- | ------------------------------------------------- |
| `sockfd`    | UDP μ†μΌ“ νμΌ λ””μ¤ν¬λ¦½ν„°                          |
| `buf`       | λ³΄λ‚Ό λ°μ΄ν„° λ²„νΌ                                  |
| `len`       | λ³΄λ‚Ό λ°μ΄ν„° κΈΈμ΄                                  |
| `flags`     | μΌλ°μ μΌλ΅ `0`                                    |
| `dest_addr` | λ©μ μ§€ μ£Όμ† (`struct sockaddr_in*`)               |
| `addrlen`   | μ£Όμ† κµ¬μ΅°μ²΄μ ν¬κΈ° (`sizeof(struct sockaddr_in)`) |

#### β… λ°ν™κ°’

- μ„±κ³µ: μ „μ†΅ν• λ°”μ΄νΈ μ
- μ‹¤ν¨: `-1` λ°ν™

#### π§ μμ 

```
sendto(sock, "PING", 4, 0, (struct sockaddr*)&server_addr, sizeof(server_addr));
```

------

### π“ `recvfrom()` ν•¨μ

#### π“ μ •μ

```
ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags,
                 struct sockaddr *src_addr, socklen_t *addrlen);
```

| μΈμ       | μ„¤λ…                                        |
| ---------- | ------------------------------------------- |
| `sockfd`   | μμ‹  λ€κΈ° μ¤‘μΈ μ†μΌ“ FD                      |
| `buf`      | μμ‹  λ°μ΄ν„°λ¥Ό μ €μ¥ν•  λ²„νΌ                   |
| `len`      | λ²„νΌ ν¬κΈ°                                   |
| `flags`    | μΌλ°μ μΌλ΅ `0`                              |
| `src_addr` | λ°μ΄ν„°λ¥Ό λ³΄λ‚Έ ν΄λΌμ΄μ–ΈνΈμ μ£Όμ† (μ¶μ² μ €μ¥) |
| `addrlen`  | μ£Όμ† κµ¬μ΅°μ²΄μ ν¬κΈ° (μ…μ¶λ ¥)                 |

#### β… λ°ν™κ°’

- μ„±κ³µ: μμ‹ ν• λ°”μ΄νΈ μ
- μ‹¤ν¨: `-1` λ°ν™

#### π§ μμ 

```
char buffer[1024];
struct sockaddr_in client;
socklen_t clen = sizeof(client);

int n = recvfrom(sock, buffer, sizeof(buffer), 0,
                 (struct sockaddr*)&client, &clen);
```

- ν΄λΌμ΄μ–ΈνΈ μ£Όμ†λ” `client`μ— μ €μ¥λ¨
- μ‘λ‹µ λ³΄λ‚Ό λ•λ” μ΄ μ£Όμ†λ¥Ό κ·Έλ€λ΅ `sendto()`μ— μ¬μ‚¬μ©

------

### β… μ£Όμ” μ‚¬μ© μ‹λ‚λ¦¬μ¤

| μƒν™©           | `recvfrom()`                         | `sendto()`                   |
| -------------- | ------------------------------------ | ---------------------------- |
| UDP μ„λ²„       | ν΄λΌμ΄μ–ΈνΈ μ£Όμ†λ¥Ό μ•μ•„μ•Ό ν•λ―€λ΅ μ‚¬μ© | μ‘λ‹µμ„ λ³΄λ‚΄κΈ° μ„ν•΄ μ‚¬μ©      |
| UDP ν΄λΌμ΄μ–ΈνΈ | λ³΄ν†µ μƒλ€ μ£Όμ† ν•„μ” μ—†μ β†’ NULL κ°€λ¥ | ν•­μƒ λ©μ μ§€ μ£Όμ† μ§€μ •ν•΄μ•Ό ν•¨ |

```
recvfrom(sock, buffer, sizeof(buffer), 0, NULL, NULL); // μ£Όμ† λ¬΄μ‹ κ°€λ¥
```

------

### π“ flags μµμ…

- `MSG_DONTWAIT`: λΈ”λ΅ν‚Ή μ—†μ΄ νΈμ¶
- `MSG_PEEK`: λ°μ΄ν„°λ¥Ό μ†λΉ„ν•μ§€ μ•κ³  λ―Έλ¦¬ λ³΄κΈ°

```
recvfrom(sock, buffer, sizeof(buffer), MSG_PEEK, NULL, NULL); // λ²„νΌ μ μ§€λ¨
```

------

### β… μ •λ¦¬ μ”μ•½

| ν•­λ©      | `sendto()`                    | `recvfrom()`           |
| --------- | ----------------------------- | ---------------------- |
| λ™μ‘      | λ°μ΄ν„°λ¥Ό μ „μ†΅                 | λ°μ΄ν„°λ¥Ό μμ‹           |
| μ£Όμ† ν•„μ” | λ©μ μ§€ μ£Όμ† ν•„μ              | μ¶μ² μ£Όμ† μ €μ¥μ©       |
| UDP μ„λ²„  | ν΄λΌμ΄μ–ΈνΈ μ‘λ‹µ μ‹ μ‚¬μ©       | ν΄λΌμ΄μ–ΈνΈ μ£Όμ† μ¶”μ¶μ© |
| TCPμ—μ„   | λ³΄ν†µ μ‚¬μ© μ• ν•¨ (stream κΈ°λ°) | μ‚¬μ© μ• ν•¨             |

## 4.3 ν΄λΌμ΄μ–ΈνΈ μ£Όμ† μ‹λ³„ λ° μ²λ¦¬

### π“ μ™ μ‹λ³„μ΄ ν•„μ”ν•κ°€?

UDPλ” μƒνƒλ¥Ό μ μ§€ν•μ§€ μ•μ•„, μ„λ²„κ°€ μμ‹ ν• λ°μ΄ν„°κ°€ **λ„κ°€ λ³΄λƒλ”μ§€** μ• μ μ—†μΌλ©΄ **μ‘λ‹µμ„ λ³΄λ‚Ό μ μ—†λ‹¤**.

λ”°λΌμ„ `recvfrom()` νΈμ¶ μ‹ **λ°μ‹ μ μ£Όμ†λ¥Ό ν•¨κ» μ¶”μ¶**ν•΄μ„ μ €μ¥ν•΄λ‘κ³ , `sendto()` νΈμ¶ μ‹ κ·Έ μ£Όμ†λ¥Ό μ΄μ©ν•΄μ„ λ‹¤μ‹ μ‘λ‹µμ„ λ³΄λ‚΄λ” λ°©μ‹μΌλ΅ μ‘λ™ν•΄μ•Ό ν•¨.

------

### π“ κΈ°λ³Έ μμ  μ½”λ“ (UDP μ„λ²„)

```
#include <stdio.h>
#include <string.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <unistd.h>

int main() {
    int sock;
    struct sockaddr_in server_addr, client_addr;
    socklen_t client_len = sizeof(client_addr);
    char buffer[1024];

    sock = socket(AF_INET, SOCK_DGRAM, 0);
    
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(8888);
    server_addr.sin_addr.s_addr = htonl(INADDR_ANY);

    bind(sock, (struct sockaddr*)&server_addr, sizeof(server_addr));

    while (1) {
        int n = recvfrom(sock, buffer, sizeof(buffer), 0,
                         (struct sockaddr*)&client_addr, &client_len);

        buffer[n] = '\0';

        printf("π‘¤ Client IP: %s, Port: %d\n",
               inet_ntoa(client_addr.sin_addr), ntohs(client_addr.sin_port));
        printf("π“¥ Received: %s\n", buffer);

        // μ‘λ‹µ μ „μ†΅
        sendto(sock, buffer, n, 0,
               (struct sockaddr*)&client_addr, client_len);
    }

    close(sock);
    return 0;
}
```

------

### β… ν•µμ‹¬ ν•¨μ: `inet_ntoa()`, `ntohs()`

- `inet_ntoa(client_addr.sin_addr)` β†’ IPv4 μ£Όμ† λ¬Έμμ—΄ λ°ν™
- `ntohs(client_addr.sin_port)` β†’ ν¬νΈ λ²νΈλ¥Ό νΈμ¤νΈ λ°”μ΄νΈ μμ„λ΅ λ³€ν™

------

### π§  ν΄λΌμ΄μ–ΈνΈλ³„ μ‘λ‹µ λ¶„κΈ° μ²λ¦¬ μμ‹

```
if (strcmp(inet_ntoa(client_addr.sin_addr), "192.168.0.100") == 0) {
    printf("νΉμ • ν΄λΌμ΄μ–ΈνΈ μ²λ¦¬ λ΅μ§ μ‹¤ν–‰\n");
}
```

------

### π“¦ μ‘μ©: ν΄λΌμ΄μ–ΈνΈ μ£Όμ†λ¥Ό λ¬Έμμ—΄λ΅ μ €μ¥

```
char ip_str[INET_ADDRSTRLEN];
inet_ntop(AF_INET, &(client_addr.sin_addr), ip_str, sizeof(ip_str));

printf("ν΄λΌμ΄μ–ΈνΈ IP λ¬Έμμ—΄: %s\n", ip_str);
```

> IPv6μ κ²½μ° `AF_INET6`μ™€ `struct sockaddr_in6`λ¥Ό μ‚¬μ©ν•λ©΄ λ¨.

------

### π”’ μ£Όμν•  μ 

- UDPλ” μƒνƒκ°€ μ—†μΌλ―€λ΅, **λ§¤λ² μ£Όμ†λ¥Ό μ €μ¥ν•κ³  μ°Έμ΅°**ν•΄μ•Ό ν•λ‹¤.
- ν΄λΌμ΄μ–ΈνΈμ™€μ μƒνƒ μ μ§€κ°€ ν•„μ”ν•λ©΄, μ£Όμ†λ³„λ΅ contextλ¥Ό **λ³„λ„ κµ¬μ΅°μ²΄λ‚ ν•΄μ‹λ§µμ— μ €μ¥**ν•λ” λ°©μ‹μΌλ΅ κµ¬μ„±ν•΄μ•Ό ν•¨.
- λ™μΌ ν΄λΌμ΄μ–ΈνΈλΌλ„ **ν¬νΈκ°€ λ°”λ€λ©΄ λ‹¤λ¥Έ μ—”ν‹°ν‹°λ΅ κ°„μ£Ό**λλ‹¤.

------

### β… μ”μ•½

| ν•­λ©        | λ‚΄μ©                                 |
| ----------- | ------------------------------------ |
| μ£Όμ† μ¶”μ¶   | `recvfrom()`μ `src_addr` μΈμ μ‚¬μ©  |
| λ¬Έμμ—΄ λ³€ν™ | `inet_ntoa()`, `inet_ntop()` μ‚¬μ©    |
| ν¬νΈ μ¶”μ¶   | `ntohs(client_addr.sin_port)`        |
| μ‘λ‹µ μ „μ†΅   | `sendto()`μ—μ„ μ¶”μ¶λ μ£Όμ† μ¬μ‚¬μ©    |
| ν™•μ¥ μ²λ¦¬   | ν΄λΌμ΄μ–ΈνΈλ³„ κµ¬μ΅°μ²΄ κ΄€λ¦¬λ΅ μƒνƒ μ¶”μ  |

## 4.4 UDP ν¨ν‚· μ†μ‹¤/μμ„ λ¬Έμ  λ€μ‘

### π¨ UDPμ μ£Όμ” ν•κ³„

| λ¬Έμ                | μ„¤λ…                                                   |
| ------------------ | ------------------------------------------------------ |
| β ν¨ν‚· μ†μ‹¤        | μ¤‘κ°„μ— ν¨ν‚·μ΄ μ μ‹¤λμ–΄λ„ μ¬μ „μ†΅ν•μ§€ μ•μ               |
| β μμ„ λ³΄μ¥ μ—†μ   | μμ‹  μμ„κ°€ μ†΅μ‹  μμ„μ™€ λ‹¤λ¥Ό μ μμ                   |
| β νλ¦„ μ μ–΄ μ—†μ   | μ†΅μ‹ μκ°€ κ³Όλ„ν•κ² λ³΄λ‚΄λ©΄ μμ‹ μκ°€ λ²„νΌ μ¤λ²„ν”λ΅μ° κ°€λ¥ |
| β μ¤‘λ³µ μμ‹  κ°€λ¥μ„± | κ°™μ€ ν¨ν‚·μ΄ λ‘ λ² λ„μ°©ν•  μλ„ μμ                     |

------

### β… μΌλ°μ μΈ λ€μ‘ μ „λµ

#### 1. **μ‹ν€€μ¤ λ²νΈ λ¶€μ—¬**

```
struct packet {
    uint32_t seq_num;   // μ‹ν€€μ¤ λ²νΈ
    char data[1024];    // μ‹¤μ  λ°μ΄ν„°
};
```

- μμ‹ μλ” `seq_num` κΈ°μ¤€μΌλ΅ μ •λ ¬ν•κ±°λ‚ μ¤‘λ³µ μ κ±° κ°€λ¥
- μ†΅μ‹ μλ” μ†΅μ‹ ν• ν¨ν‚·μ„ `seq_num` κΈ°μ¤€μΌλ΅ μ¬μ „μ†΅ κ΄€λ¦¬ κ°€λ¥

------

#### 2. **ACK/NACK (μ‘λ‹µ) κΈ°λ° μ¬μ „μ†΅ κµ¬ν„**

- ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„λ΅ μ „μ†΅ ν›„, μ„λ²„κ°€ `ACK(seq_num)` μ‘λ‹µ
- μ‘λ‹µμ΄ μΌμ • μ‹κ°„ λ‚΄ λ„μ°©ν•μ§€ μ•μΌλ©΄ ν΄λΌμ΄μ–ΈνΈκ°€ μ¬μ „μ†΅

```
// sendto() ν›„ select()λ΅ μ‘λ‹µ λ€κΈ°
fd_set readfds;
struct timeval timeout = {2, 0}; // 2μ΄ λ€κΈ°

FD_ZERO(&readfds);
FD_SET(sockfd, &readfds);

int ready = select(sockfd + 1, &readfds, NULL, NULL, &timeout);
if (ready == 0) {
    // νƒ€μ„μ•„μ›ƒ: μ¬μ „μ†΅ λ΅μ§
}
```

------

#### 3. **μμ„ μ¬μ΅°λ¦½ λ²„νΌ μ‚¬μ©**

- λ„μ°©ν• ν¨ν‚·μ„ μ„μ‹ λ²„νΌμ— μ €μ¥
- `seq_num`μ΄ λ„λ½λ κ²½μ° λ‹¤μ ν¨ν‚·μ€ μΌλ‹¨ λ³΄λ¥
- λ„λ½λ ν¨ν‚· λ„μ°© μ‹ μ¬μ΅°λ¦½

```
// Pseudo-buffer: λ²„νΌ[seq_num] = λ°μ΄ν„°
char* reassembly_buffer[MAX_SEQ];
```

------

#### 4. **Sliding Window (μ¬λΌμ΄λ”© μλ„μ°) κΈ°λ²•**

- μ—¬λ¬ ν¨ν‚·μ„ μ—°μ†ν•΄μ„ λ³΄λ‚΄λ, μΌμ • λ²”μ„(window) λ‚΄μ—μ„λ§ ACK ν™•μΈ
- TCPμ™€ μ μ‚¬ν• νλ¦„ μ μ–΄ κ°€λ¥
- κµ¬ν„μ€ λ³µμ΅ν•μ§€λ§ μ„±λ¥/μ‹ λΆ°μ„± κ°μ„  ν¨κ³Ό νΌ

------

#### 5. **μ‘μ© κ³„μΈµμ—μ„ μμ„ λ³΄μ¥ λ΅μ§ μ‘μ„±**

- λ³΄λ‚Έ μμ„λ€λ΅ ν μ²λ¦¬ν•κ³ ,
- μ΄μ „ μ‹ν€€μ¤λ³΄λ‹¤ λ‚®μ€ λ²νΈλ” λ¬΄μ‹ν•κ±°λ‚ λ²„νΌμ— λ³΄κ΄€
- λ°μ΄ν„°λ² μ΄μ¤λ‚ λ΅κ·Έ μ²λ¦¬ μ‹ μ μ©

------

### π“¦ μμ‹ μ‹ν€€μ¤ λ²νΈ ν¬ν•¨ μ†΅μμ‹  κµ¬μ΅°

#### μ†΅μ‹  μΈ΅

```
struct packet pkt;
pkt.seq_num = htonl(1);
strcpy(pkt.data, "Hello");

sendto(sock, &pkt, sizeof(pkt), 0,
       (struct sockaddr*)&addr, sizeof(addr));
```

#### μμ‹  μΈ΅

```
struct packet recv_pkt;
recvfrom(sock, &recv_pkt, sizeof(recv_pkt), 0,
         (struct sockaddr*)&client, &len);

uint32_t seq = ntohl(recv_pkt.seq_num);
printf("λ°›μ€ μ‹ν€€μ¤ λ²νΈ: %u\n", seq);
```

------

### β… μ‹¤μ  μ‹μ¤ν…μ—μ„μ μ

| μ‹μ¤ν…              | ν•΄κ²° μ „λµ                                               |
| ------------------- | ------------------------------------------------------- |
| **VoIP**            | μ‹¤μ‹κ°„μ„± μ¤‘μ” β†’ μΌλ¶€ μ†μ‹¤ ν—μ©, μμ„ μ •λ ¬ μ‚¬μ©          |
| **TFTP**            | λ‹¨μ ACK μ¬μ „μ†΅ κΈ°λ° μ‹ λΆ°μ„± ν™•λ³΄                        |
| **DNS**             | μ†μ‹¤ μ‹ ν΄λΌμ΄μ–ΈνΈκ°€ μ¬μ”μ²­                             |
| **QUIC (UDP κΈ°λ°)** | μμ²΄ μ‹ν€€μ¤/ACK/μ¬μ „μ†΅ κΈ°λ¥ κµ¬ν„ β†’ TCP μμ¤€ μ‹ λΆ°μ„± μ κ³µ |

------

### π§  μ”μ•½

| λ¬Έμ         | λ€μ‘ μ „λµ                   |
| ----------- | --------------------------- |
| ν¨ν‚· μ†μ‹¤   | ACK/NACK + μ¬μ „μ†΅           |
| μμ„ λ’¤λ°”λ€ | μ‹ν€€μ¤ λ²νΈ + μ¬μ΅°λ¦½ λ²„νΌ   |
| μ¤‘λ³µ μμ‹    | seq_num μ¤‘λ³µ μ²΄ν¬           |
| νλ¦„ μ μ–΄   | μ¬λΌμ΄λ”© μλ„μ° κΈ°λ²• λ„μ…   |
| μ§€μ—°/λ¬΄μ‘λ‹µ | νƒ€μ„μ•„μ›ƒ + select/poll μ‚¬μ© |

## 4.5 DNS ν΄λΌμ΄μ–ΈνΈ μƒν” κµ¬ν„

### π“ κΈ°λ³Έ κ°μ”

- ν”„λ΅ν† μ½: **UDP 53λ² ν¬νΈ**
- λ©μ μ§€: **DNS μ„λ²„ (μ: 8.8.8.8)**
- κµ¬μ΅°: **DNS Query ν¨ν‚· μƒμ„± β†’ UDP μ „μ†΅ β†’ μ‘λ‹µ μμ‹  λ° νμ‹±**

------

### π§± DNS ν¨ν‚· κµ¬μ΅° (κ°„λµν™”)

| ν•„λ“                          | μ„¤λ…                           |
| ----------------------------- | ------------------------------ |
| Header (12 bytes)             | ID, flags, question count λ“±   |
| Question                      | μ§μ μ΄λ¦„, νƒ€μ…(A), ν΄λμ¤(IN) |
| Answer, Authority, Additional | μ‘λ‹µ μ„Έλ¶€ μ •λ³΄ (μƒλµ κ°€λ¥)     |

------

### β™οΈ μ£Όμ” ν—¤λ” κµ¬μ΅°μ²΄

```
struct DNS_HEADER {
    uint16_t id;       // ID
    uint16_t flags;    // Query/Response flags
    uint16_t q_count;  // μ§λ¬Έ μ
    uint16_t ans_count;
    uint16_t auth_count;
    uint16_t add_count;
};

struct QUESTION {
    uint16_t qtype;
    uint16_t qclass;
};
```

------

### π› οΈ λ„λ©”μΈ μ΄λ¦„ λ³€ν™ ν•¨μ (μ: "[www.google.com](http://www.google.com)" β†’ `\3www\6google\3com\0`)

```
void ChangetoDnsNameFormat(unsigned char* dns, const char* host) {
    int lock = 0, i;
    strcat((char*)host, ".");
    for (i = 0; i < strlen((char*)host); i++) {
        if (host[i] == '.') {
            *dns++ = i - lock;
            for (; lock < i; lock++) {
                *dns++ = host[lock];
            }
            lock++;
        }
    }
    *dns++ = 0; // λ ν‘μ‹
}
```

------

### β… μ „μ²΄ μμ  μ½”λ“ (κΈ°λ³Έ DNS A λ μ½”λ“ μ§μ)

```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

#define DNS_PORT 53
#define BUF_SIZE 512

struct DNS_HEADER {
    uint16_t id, flags, q_count, ans_count, auth_count, add_count;
};

struct QUESTION {
    uint16_t qtype, qclass;
};

void ChangetoDnsNameFormat(unsigned char* dns, const char* host) {
    int lock = 0, i;
    strcat((char*)host, ".");
    for (i = 0; i < strlen((char*)host); i++) {
        if (host[i] == '.') {
            *dns++ = i - lock;
            for (; lock < i; lock++) *dns++ = host[lock];
            lock++;
        }
    }
    *dns++ = 0;
}

int main() {
    unsigned char buf[BUF_SIZE], *qname;
    struct DNS_HEADER* dns = NULL;
    struct QUESTION* qinfo = NULL;

    struct sockaddr_in dest;
    int sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);
    if (sock < 0) { perror("socket"); exit(1); }

    dest.sin_family = AF_INET;
    dest.sin_port = htons(DNS_PORT);
    dest.sin_addr.s_addr = inet_addr("8.8.8.8");  // Google DNS

    dns = (struct DNS_HEADER*)&buf;

    dns->id = (uint16_t) htons(getpid());
    dns->flags = htons(0x0100);  // ν‘μ¤€ μΏΌλ¦¬
    dns->q_count = htons(1);
    dns->ans_count = dns->auth_count = dns->add_count = 0;

    qname = &buf[sizeof(struct DNS_HEADER)];
    ChangetoDnsNameFormat(qname, "example.com");

    qinfo = (struct QUESTION*)&buf[sizeof(struct DNS_HEADER) + strlen((const char*)qname) + 1];
    qinfo->qtype = htons(1);   // A λ μ½”λ“
    qinfo->qclass = htons(1);  // IN

    int len = sizeof(struct DNS_HEADER) + strlen((const char*)qname) + 1 + sizeof(struct QUESTION);
    sendto(sock, buf, len, 0, (struct sockaddr*)&dest, sizeof(dest));

    socklen_t slen = sizeof(dest);
    int rlen = recvfrom(sock, buf, BUF_SIZE, 0, (struct sockaddr*)&dest, &slen);

    printf("π§Ύ μ‘λ‹µ μμ‹ λ¨ (%d λ°”μ΄νΈ)\n", rlen);
    close(sock);
    return 0;
}
```

------

### π§  ν•΄μ„ κ²°κ³Ό λ³΄κΈ°

μ„ μ½”λ“λ” μ‘λ‹µκΉμ§€ λ°›μ§€λ§, μ•„μ§ μ‘λ‹µ νμ‹±μ€ μ• ν•¨.
 λ‹¤μ λ‹¨κ³„μ—μ„λ” `buf` λ‚΄ μ‘λ‹µμ„ ν•΄μ„ν•΄μ„ A λ μ½”λ“(IP) μ¶”μ¶ κ°€λ¥. μ΄κ±΄ λ°”μ΄λ„λ¦¬ λ””μ½”λ”©μ΄ ν•„μ”ν•΄μ„ λ”°λ΅ λ‹¤λ¤„μ•Ό ν•λ‹¤.

------

### π§© μ‘μ© ν

- `qtype`μ„ 28λ΅ μ„¤μ •ν•λ©΄ IPv6 μ£Όμ†(AAAA λ μ½”λ“) μ”μ²­ κ°€λ¥
- `recvfrom()` μ‘λ‹µμ€ DNS μ‘λ‹µ ν—¤λ” + μ‘λ‹µ λ¦¬μ¤νΈ β†’ μ¶”μ¶ ν•„μ”
- `tcpdump -i lo udp port 53`μΌλ΅ μ‹¤μ  μ „μ†΅ ν™•μΈ κ°€λ¥